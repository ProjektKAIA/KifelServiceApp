rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ============================================
    // USERS COLLECTION
    // ============================================

    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isOwner(userId) || isAdmin();

      // Users can update their own profile (except role), admins can update all
      allow update: if (isOwner(userId) && !('role' in request.resource.data)) || isAdmin();

      // Only admins can create/delete users
      allow create, delete: if isAdmin();
    }

    // ============================================
    // SHIFTS COLLECTION
    // ============================================

    match /shifts/{shiftId} {
      // Users can read their own shifts, admins can read all
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());

      // Only admins can create/update/delete shifts
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // TIME ENTRIES COLLECTION
    // ============================================

    match /timeEntries/{entryId} {
      // Users can read their own entries, admins can read all
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());

      // Users can create their own entries
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // Users can update their own entries (but NOT approval fields), admins can update all
      allow update: if isAuthenticated() &&
        (
          (resource.data.userId == request.auth.uid &&
            // Employees dürfen Approval-Felder nicht ändern
            request.resource.data.approvalStatus == resource.data.approvalStatus &&
            request.resource.data.approvalNote == resource.data.approvalNote &&
            request.resource.data.reviewedBy == resource.data.reviewedBy &&
            request.resource.data.reviewedAt == resource.data.reviewedAt
          )
          || isAdmin()
        );

      // Only admins can delete entries
      allow delete: if isAdmin();
    }

    // ============================================
    // VACATION REQUESTS COLLECTION
    // ============================================

    match /vacationRequests/{requestId} {
      // Users can read their own requests, admins can read all
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());

      // Users can create their own requests
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.status == 'pending';

      // Users can update their own pending requests, admins can update all
      allow update: if isAuthenticated() &&
        ((resource.data.userId == request.auth.uid && resource.data.status == 'pending') || isAdmin());

      // Users can delete their own pending requests, admins can delete all
      allow delete: if isAuthenticated() &&
        ((resource.data.userId == request.auth.uid && resource.data.status == 'pending') || isAdmin());
    }

    // ============================================
    // CHAT ROOMS COLLECTION
    // ============================================

    match /chatRooms/{roomId} {
      // All authenticated users can read team rooms
      allow read: if isAuthenticated() &&
        (resource.data.type == 'team' || request.auth.uid in resource.data.members);

      // Only admins can create/update/delete rooms
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // CHAT MESSAGES COLLECTION
    // ============================================

    match /chatMessages/{messageId} {
      // All authenticated users can read messages (team chat)
      allow read: if isAuthenticated();

      // Users can create their own messages with content limit
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.content is string &&
        request.resource.data.content.size() <= 500 &&
        request.resource.data.roomId is string;

      // Users can update their own messages (soft delete), admins can update all
      allow update: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());

      // Only admins can delete messages
      allow delete: if isAdmin();
    }

    // ============================================
    // LOCATIONS COLLECTION
    // ============================================

    match /locations/{locationId} {
      // All authenticated users can read locations
      allow read: if isAuthenticated();

      // Only admins can manage locations
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // INVITES COLLECTION
    // ============================================

    match /invites/{inviteId} {
      // List: public access for token-based invite lookup (getByToken query)
      // Token is 32 chars from 55-char alphabet (~183 bit entropy) — brute-force infeasible
      allow list: if true;

      // Single doc reads by ID require authentication
      allow get: if isAuthenticated();

      // Only admins can create invites
      allow create: if isAdmin();

      // Admins can update/delete, authenticated users can accept (update status)
      allow update: if isAdmin() || isAuthenticated();

      // Only admins can delete invites
      allow delete: if isAdmin();
    }

    // ============================================
    // DELETION REQUESTS COLLECTION
    // ============================================

    match /deletionRequests/{requestId} {
      // Users can read their own requests, admins can read all
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());

      // Authenticated users can create their own requests
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // Only admins can update (approve/reject)
      allow update: if isAdmin();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ============================================
    // ADMIN NOTIFICATIONS COLLECTION
    // ============================================

    match /adminNotifications/{notificationId} {
      // Admins can read their own notifications
      allow read: if isAdmin();

      // Authenticated users can create notifications (e.g. profile change triggers)
      allow create: if isAuthenticated();

      // Admins can update (mark as read) and delete their notifications
      allow update, delete: if isAdmin();
    }

    // ============================================
    // COMPANY COLLECTION
    // ============================================

    match /company/{companyId} {
      // All authenticated users can read company info
      allow read: if isAuthenticated();

      // Only admins can manage company data
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // PUSH TOKENS COLLECTION
    // ============================================

    match /pushTokens/{tokenId} {
      // Users can only read their own tokens
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Users can create their own tokens
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // Users can update their own tokens (e.g., deactivate)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Users can delete their own tokens
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================
    // NOTIFICATION PREFERENCES COLLECTION
    // ============================================

    match /notificationPreferences/{userId} {
      // Users can only read their own preferences
      allow read: if isOwner(userId);

      // Users can create/update their own preferences
      allow create, update: if isOwner(userId);

      // Users can delete their own preferences
      allow delete: if isOwner(userId);
    }
  }
}
